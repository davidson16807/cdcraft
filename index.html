<!doctype html>
<html>
<head>
    <title>cdcraft</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="./styles/katex.min.css">
    <link rel="stylesheet" href="./styles/bootstrap.css">
    <link rel="stylesheet" href="./styles/main.css">
    <link rel="stylesheet" href="./styles/controls.css">
    <script src="./libraries/glm-js.min.js"></script>
    <script src="./libraries/katex.min.js"></script>
    <script src="./libraries/auto-render.min.js"></script>
    <script src="./scripts/DiagramIds.js"></script>
    <script src="./scripts/CellHashing.js"></script>
    <script src="./scripts/frames/ScreenReferenceFrameStorage.js"></script>
    <script src="./scripts/frames/DiagramReferenceFrame.js"></script>
    <script src="./scripts/frames/FrameShifting.js"></script>
    <script src="./scripts/frames/ScreenReferenceFrameStore.js"></script>
    <script src="./scripts/models/arcs/StoredArc.js"></script>
    <script src="./scripts/models/arcs/UserArc.js"></script>
    <script src="./scripts/models/arcs/SvgArc.js"></script>
    <script src="./scripts/models/arcs/SamplerArc.js"></script>
    <script src="./scripts/models/arcs/ArcGeometry.js"></script>
    <script src="./scripts/models/arcs/SamplerArcRendering.js"></script>
    <script src="./scripts/models/arcs/SamplerArcResizing.js"></script>
    <script src="./scripts/models/arcs/SamplerArcProperties.js"></script>
    <script src="./scripts/models/arcs/SamplerArcFrameShifting.js"></script>
    <script src="./scripts/models/arcs/UserArcsAndSvgArcs.js"></script>
    <script src="./scripts/models/arcs/UserArcFrameShifting.js"></script>
    <script src="./scripts/models/arcs/UserArcsAndSamplerArcs.js"></script>
    <script src="./scripts/models/arcs/UserArcsAndStoredArcs.js"></script>
    <script src="./scripts/models/arrows/Arrow.js"></script>
    <script src="./scripts/models/arrows/DiagramArrow.js"></script>
    <script src="./scripts/models/arrows/DiagramArrowListsAndLookups.js"></script>
    <script src="./scripts/models/objects/DiagramObject.js"></script>
    <script src="./scripts/models/objects/DiagramObjectSetOperations.js"></script>
    <script src="./scripts/models/diagrams/Diagram.js"></script>
    <script src="./scripts/models/diagrams/DiagramMetrics.js"></script>
    <script src="./scripts/models/app/AppState.js"></script>
    <script src="./scripts/models/app/AppHistoryTraversal.js"></script>
    <script src="./scripts/models/app/AppDragOperations.js"></script>
    <script src="./scripts/views/ViewEventDeferal.js"></script>
    <script src="./scripts/views/SvgObjectView.js"></script>
    <script src="./scripts/views/SvgObjectSelectionView.js"></script>
    <script src="./scripts/views/SvgArrowAttributes.js"></script>
    <script src="./scripts/views/SvgArrowView.js"></script>
    <script src="./scripts/views/SvgArrowSelectionView.js"></script>
    <script src="./scripts/views/SvgGridView.js"></script>
    <script src="./scripts/views/SvgAppView.js"></script>
    <script src="./scripts/dom/Html.js"></script>
    <script src="./scripts/dom/Svg.js"></script>
    <script src="./scripts/updaters/drags/ViewDrags.js"></script>
    <script src="./scripts/updaters/drags/SelectionDrags.js"></script>
    <script src="./scripts/updaters/drags/ArrowDrags.js"></script>
    <script src="./scripts/updaters/drags/DragState.js"></script>
    <script src="./scripts/updaters/AppUpdater.js"></script>
    <script src="./scripts/resources/ArrowPositionsResource.js"></script>
    <script src="./scripts/resources/ObjectPositionResource.js"></script>
    <script src="./scripts/resources/PositionMapOperations.js"></script>
    <style type="text/css">

        /*
        NOTE: styling for solid black elements is repeated here to fix a 
        cosmetic issue with a dark mode plugin I use, 
        which likely exists other dark mode plugins.
        */
        .arrow {
            stroke: black;
        }

        .object {
            color: black;
        }

    </style>

</head>
<body>

<div class="bottom right mobile title">∙⇆∙</div>

<div id="toolbar" class="top left short-axis-group collapse control">

    <div class="desktop banner"> 
        <div class="short-screen title">∙⇆∙</div>
        <div class="wide-screen title">∙⇆∙ cdcraft</div>
        <div class="wide-screen subtitle">A workspace of commutative diagrams</div>
    </div>

    <button type="button" class="btn btn-large">
        <div>Save</div>
        <img src="icons/save.svg"/>
        <div class="instructions">ctrl+S</div>
    </button>

    <button type="button" class="btn btn-large">
        <div>Load</div>
        <img src="icons/load.svg"/>
        <div class="instructions">ctrl+O</div>
    </button>

    <button id="undo" type="button" class="btn btn-large">
        <div>Undo</div>
        <img src="icons/undo.svg"/>
        <div class="instructions">ctrl+Z</div>
    </button>

    <button id="redo" type="button" class="btn btn-large">
        <div>Redo</div>
        <img src="icons/redo.svg"/>
        <div class="instructions">ctrl+Y</div>
    </button>

    <button type="button" class="btn btn-large">
        <div>Copy</div>
        <img src="icons/copy.svg"/>
        <div class="instructions">ctrl+C</div>
    </button>

    <button type="button" class="btn btn-large">
        <div>Cut</div>
        <img src="icons/cut.svg"/>
        <div class="instructions">ctrl+C</div>
    </button>

    <button type="button" class="btn btn-large">
        <div>Paste</div>
        <img src="icons/paste.svg"/>
        <div class="instructions">ctrl+V</div>
    </button>

    <button id="toggle grid" type="button" class="btn btn-large">
        <div id="toggle grid label" >Hide&nbsp;Grid</div>
        <img src="icons/grid.svg"/>
        <div class="instructions">&nbsp;</div>
    </button>

</div>

<svg id="graphics">
    <g id="transformation">
        <g id="cell-borders"></g>
        <g id="object-selections"></g>
        <g id="arrow-selections"></g>
        <g id="objects"></g>
        <g id="arrows"></g>
        <g id="object-selection-hitboxes" class="hitbox"></g>
        <g id="arrow-selection-hitboxes" class="hitbox"></g>
    </g>
</svg>


<script type="text/javascript">
'use strict';

const diagram_ids = DiagramIds(UnboundedCellHashing(PositiveCellHashing()));

const user_arcs_and_stored_arcs =
    UserArcsAndStoredArcs(
        diagram_ids, 
        0.025, 0.5, 0.25, 0.25, // min loop, max loop, loop snap, nonloop snap
        0.08, // target offset distance
    );
const user_arcs_and_sampler_arcs = UserArcsAndSamplerArcs(ArcGeometry());

const offset_shifting = OffsetFrameShifting();
const position_shifting = PositionFrameShifting();

const sampler_arc_properties = SamplerArcProperties();
const sampler_arc_resizing = SamplerArcResizing(sampler_arc_properties);
const sampler_arc_rendering = SamplerArcRendering(sampler_arc_properties);
const sampler_arc_shifting = SamplerArcFrameShifting(offset_shifting, position_shifting);

const screen_frame_storage = ScreenReferenceFrameStorage();


const diagram_object_set_ops = DiagramObjectSetOperations(diagram_ids);

const svg  = Svg();
const html = Html();
const view_event_deferal = ViewEventDeferal;

const grid_view = 
    SvgGridView({
        svg                        : svg,
        screen_frame_storage       : screen_frame_storage,
        diagram_ids                : diagram_ids,
        position_shifting          : position_shifting,
    });

const svg_arrow_attributes = 
    SvgArrowAttributes({
        screen_frame_storage       : screen_frame_storage,
        user_arcs_and_stored_arcs  : user_arcs_and_stored_arcs,
        user_arcs_and_sampler_arcs : user_arcs_and_sampler_arcs,
        sampler_arc_resizing       : sampler_arc_resizing,
        sampler_arc_shifting       : sampler_arc_shifting,
        sampler_arc_properties     : sampler_arc_properties,
        sampler_arc_rendering      : sampler_arc_rendering,
        position_shifting          : position_shifting,
        offset_shifting            : offset_shifting,
    }, 
    { 
        source_trim_length: 0.12,
        target_trim_length: 0.10,
    });

const arrow_view = SvgArrowView(svg, svg_arrow_attributes, view_event_deferal);
const arrow_selection_view = SvgArrowSelectionView(svg, svg_arrow_attributes, view_event_deferal);

const object_view = 
    SvgObjectView({
        svg                        : svg,
        html                       : html,
        screen_frame_storage       : screen_frame_storage,
        diagram_ids                : diagram_ids,
        position_shifting          : position_shifting,
        view_event_deferal         : view_event_deferal,
        render                     : renderMathInElement,
    });

const object_selection_view = 
    SvgObjectSelectionView({
        svg                        : svg,
        screen_frame_storage       : screen_frame_storage,
        diagram_ids                : diagram_ids,
        position_shifting          : position_shifting,
        view_event_deferal         : view_event_deferal,
    });


const selection_drags = 
    SelectionDrags(
        ArrowPositionsResource(diagram_ids, user_arcs_and_stored_arcs, true),
        ObjectPositionResource(diagram_ids, true),
        PositionMapOperations(diagram_ids),
    );

const arrow_drags = 
    ArrowDrags(
        diagram_ids,
        user_arcs_and_stored_arcs,
        1.0, // default_min_length_clockwise
        0.001 // min_length_clockwise_change_per_scroll
    );

const view_drags = 
    ViewDrags(
        screen_frame_storage,
        position_shifting,
        offset_shifting,
        -0.001, // log2_cell_width_change_per_scroll
    Math.log2(50), // log2_cell_width_min
    Math.log2(500) // log2_cell_width_max
);

const app_history_traversal = 
    AppHistoryTraversal(DiagramMetrics(), Infinity);

const drag_state_ops = 
    AppDragOperations(
        screen_frame_storage,
        offset_shifting, 
        position_shifting, 
        app_history_traversal,
    );

const app_updater = 
    AppUpdater({
        selection_drags           : selection_drags,
        arrow_drags               : arrow_drags,
        view_drags                : view_drags,
        screen_frame_storage      : screen_frame_storage,
        position_shifting         : position_shifting,
        object_position_resources : ObjectPositionResource(diagram_ids, true),                        
        diagram_ids               : diagram_ids,
        drag_state_ops            : drag_state_ops,
        app_history_traversal     : app_history_traversal,
    });

const app_view = 
    SvgAppView({
        screen_frame_storage         : screen_frame_storage,
        diagram_object_set_ops       : diagram_object_set_ops,
        svg_grid_view                : grid_view,
        svg_object_view              : object_view,
        svg_arrow_view               : arrow_view,
        svg_object_selection_view    : object_selection_view,
        svg_arrow_selection_view     : arrow_selection_view,
        view_event_deferal           : view_event_deferal,
    }, app_updater);

const initial_screen_frame_store = new ScreenReferenceFrameStore(glm.vec2(), Math.log2(150));
const disengaged_drag = view_drags.release(initial_screen_frame_store)
const disengaged_drag_state = disengaged_drag.initialize();
const app = new AppState(
        new Diagram([], [], [], [], initial_screen_frame_store), 
        disengaged_drag,
        disengaged_drag_state,
    );

app_view.wire(app, document);

</script>
</body>
</html>